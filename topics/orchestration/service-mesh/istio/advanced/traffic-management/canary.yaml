# =============================================================================
# advanced/traffic-management/canary.yaml
# =============================================================================
# Canary deployment: gradually shift traffic from v1 to v2.
# Start at 5% → monitor metrics → increase to 20% → 50% → 100%
#
# Unlike Kubernetes rolling updates (which replace pods), Istio canary
# keeps BOTH versions running simultaneously and controls traffic at the
# proxy level — no pod restarts required to shift percentages.
#
# Prerequisites:
#   - taskapp-api Service selecting pods with app=taskapp-api
#   - Deployment v1: pods labelled version=v1
#   - Deployment v2: pods labelled version=v2
#   - DestinationRule defining subsets v1 and v2
#
# Workflow:
#   kubectl apply -f canary.yaml               # start 90/10 split
#   # monitor error rate in Kiali/Grafana
#   kubectl patch vs taskapp-api-canary --type=json \
#     -p='[{"op":"replace","path":"/spec/http/0/route/0/weight","value":50},
#          {"op":"replace","path":"/spec/http/0/route/1/weight","value":50}]'
#   # when satisfied: 0/100 → delete canary VS
# =============================================================================

# ── DestinationRule: define v1 and v2 subsets ────────────────────────────────
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: taskapp-api-canary-dr
  namespace: default
spec:
  host: taskapp-api
  subsets:
    - name: v1
      labels:
        version: v1
    - name: v2
      labels:
        version: v2

---
# ── VirtualService: 90% v1 / 10% v2 canary split ─────────────────────────────
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: taskapp-api-canary
  namespace: default
spec:
  hosts:
    - taskapp-api
  http:
    - name: "canary-split"
      route:
        # weights must sum to 100
        - destination:
            host: taskapp-api
            subset: v1
          weight: 90          # 90% of requests go to v1 (stable)
        - destination:
            host: taskapp-api
            subset: v2
          weight: 10          # 10% of requests go to v2 (canary)

---
# ── Header-based canary: route testers to v2 ─────────────────────────────────
# Before shifting ALL traffic, allow specific users to test v2 by
# sending a request with the header: x-canary: "true"
# Perfect for internal QA teams, beta users, or automated smoke tests.
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: taskapp-api-header-canary
  namespace: default
spec:
  hosts:
    - taskapp-api
  http:
    # Rule 1: requests with header x-canary: true → always go to v2
    - name: "header-route-to-v2"
      match:
        - headers:
            x-canary:
              exact: "true"
      route:
        - destination:
            host: taskapp-api
            subset: v2

    # Rule 2: all other requests → go to v1
    - name: "default-route-to-v1"
      route:
        - destination:
            host: taskapp-api
            subset: v1