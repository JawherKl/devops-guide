# =============================================================================
# kubernetes/basics/service.yaml
# =============================================================================
# A Service provides a stable DNS name + IP and load-balancing across the
# Pods that match its selector — even as Pods are replaced.
#
# Service types:
#   ClusterIP     Internal only — reachable within the cluster (default)
#   NodePort      Exposes a port on every node's IP (dev/testing)
#   LoadBalancer  Provisions a cloud LB (AWS ELB, GCP LB, etc.)
#   ExternalName  Maps a service to an external DNS name
#
# This file shows all three main types. Use only one in practice.
# =============================================================================

# ── Type 1: ClusterIP (internal only — most common in production) ─────────────
apiVersion: v1
kind: Service
metadata:
  name: demo-api
  namespace: default
  labels:
    app: demo-api
  annotations:
    description: "Internal ClusterIP service for demo-api Pods"
spec:
  type: ClusterIP   # default — no external access

  # selector MUST match the Pod labels from deployment.yaml
  selector:
    app: demo-api

  ports:
    - name: http
      port: 80          # port exposed on the Service (what callers use)
      targetPort: 3000  # port on the Pod (what the container listens on)
      protocol: TCP

  # sessionAffinity: ClientIP   # enable sticky sessions (optional)

---
# ── Type 2: NodePort (for local dev / Minikube access) ───────────────────────
# Exposes the service on <NodeIP>:<nodePort> on every node.
# Port range: 30000–32767
#
# Access: minikube service demo-api-nodeport
# Or:     curl http://<node-ip>:30080
apiVersion: v1
kind: Service
metadata:
  name: demo-api-nodeport
  namespace: default
  labels:
    app: demo-api
spec:
  type: NodePort
  selector:
    app: demo-api
  ports:
    - name: http
      port: 80
      targetPort: 3000
      nodePort: 30080   # omit to let Kubernetes assign a random port in range

---
# ── Type 3: LoadBalancer (cloud environments) ─────────────────────────────────
# Provisions an external load balancer (AWS NLB/ELB, GCP LB, Azure LB).
# Only works in cloud environments or with MetalLB on bare metal.
#
# In local clusters (minikube/kind) it stays in <pending> unless you run:
#   minikube tunnel
apiVersion: v1
kind: Service
metadata:
  name: demo-api-lb
  namespace: default
  labels:
    app: demo-api
  annotations:
    # Cloud-provider-specific annotations (examples):
    # AWS: service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    # GCP: cloud.google.com/load-balancer-type: "External"
spec:
  type: LoadBalancer
  selector:
    app: demo-api
  ports:
    - name: http
      port: 80
      targetPort: 3000
  # externalTrafficPolicy: Local   # preserve client IP (prevents double-hop)