# =============================================================================
# Makefile â€” Multi-service app shortcuts
# =============================================================================
# Usage: make <target>
# Run `make help` to see all available targets.
# =============================================================================

.PHONY: help up down dev logs ps shell-api shell-db migrate seed clean nuke

# â”€â”€ Default â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
help:
	@echo ""
	@echo "  Multi-Service App â€” Available commands"
	@echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  make up          Start production stack (compose.yml only)"
	@echo "  make dev         Start development stack (auto-merges override)"
	@echo "  make down        Stop and remove containers + networks"
	@echo "  make nuke        Stop + remove containers, networks, AND volumes"
	@echo "  make logs        Follow logs for all services"
	@echo "  make ps          Show service status and health"
	@echo "  make shell-api   Open shell in running API container"
	@echo "  make shell-db    Open psql in running postgres container"
	@echo "  make seed        Run seed SQL against the database"
	@echo "  make clean       Remove stopped containers + unused images"
	@echo ""

# â”€â”€ Stack management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## Start production stack (compose.yml only â€” no dev overrides)
up:
	@[ -f .env ] || (echo "âŒ .env not found. Run: cp .env.example .env" && exit 1)
	docker compose -f compose.yml up -d --build
	@echo "âœ… Production stack started"
	@make ps

## Start development stack (auto-merges compose.override.yml)
dev:
	@[ -f .env ] || (echo "âŒ .env not found. Run: cp .env.example .env" && exit 1)
	docker compose up -d --build
	@echo "âœ… Development stack started"
	@make ps
	@echo ""
	@echo "  Services:"
	@echo "  API:      http://localhost:3000"
	@echo "  Adminer:  http://localhost:8080"
	@echo "  Mailhog:  http://localhost:8025"

## Stop and remove containers + networks (preserve volumes)
down:
	docker compose down

## Stop and remove EVERYTHING including volumes â€” destroys all data
nuke:
	@echo "âš   This will DELETE all database data. Press Ctrl+C to cancel..."
	@sleep 3
	docker compose down -v --remove-orphans
	@echo "ğŸ—‘  All containers, networks, and volumes removed"

# â”€â”€ Observability â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## Follow logs for all services
logs:
	docker compose logs -f

## Show service status + health
ps:
	docker compose ps

# â”€â”€ Debugging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## Open a shell in the running API container
shell-api:
	docker compose exec api sh

## Open psql in the running postgres container
shell-db:
	docker compose exec postgres psql -U appuser -d $${POSTGRES_DB:-appdb}

## Run seed SQL (idempotent â€” safe to run multiple times)
seed:
	docker compose exec postgres psql -U appuser -d $${POSTGRES_DB:-appdb} -f /docker-entrypoint-initdb.d/02-seed.sql
	@echo "âœ… Seed data applied"

# â”€â”€ Maintenance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## Remove stopped containers and unused images
clean:
	docker container prune -f
	docker image prune -f
	@echo "âœ… Pruned stopped containers and dangling images"

## Show disk usage by containers, images, and volumes
disk:
	docker system df