# =============================================================================
# nginx.conf — SPA (Single Page Application) server config
# Used by react-nginx.dockerfile to serve the React build output
# =============================================================================

server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;

    # ── Security headers ───────────────────────────────────────────────────────
    add_header X-Frame-Options         DENY            always;
    add_header X-Content-Type-Options  nosniff         always;
    add_header X-XSS-Protection        "1; mode=block" always;
    add_header Referrer-Policy         "strict-origin-when-cross-origin" always;
    server_tokens off;

    # ── Health check ──────────────────────────────────────────────────────────
    location /health {
        access_log off;
        return 200 'ok\n';
        add_header Content-Type text/plain;
    }

    # ── Static assets — aggressive caching ────────────────────────────────────
    # Vite/webpack hashes filenames (e.g., main.a3f8c1d.js), so these can be
    # cached forever — the filename changes when content changes.
    location ~* \.(js|css|woff2|woff|ttf|eot|svg|ico|png|jpg|jpeg|gif|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable, max-age=31536000";
        access_log off;
    }

    # ── index.html — no caching ────────────────────────────────────────────────
    # The entry point must always be fresh so the browser picks up new
    # asset filenames when a new version is deployed.
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        expires 0;
    }

    # ── SPA fallback ──────────────────────────────────────────────────────────
    # All routes not matching a static file are served index.html.
    # The React router handles the actual routing client-side.
    location / {
        try_files $uri $uri/ /index.html;
    }
}